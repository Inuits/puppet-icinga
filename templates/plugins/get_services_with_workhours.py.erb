#!/usr/bin/python

import urllib2
import json

url = '<%= @icinga_url %>'
username = '<%= @icinga_user %>'
password = '<%= @icinga_pass %>'

passman = urllib2.HTTPPasswordMgrWithDefaultRealm()
passman.add_password(None, url, username, password)
urllib2.install_opener(urllib2.build_opener(urllib2.HTTPBasicAuthHandler(passman)))

req = urllib2.Request(url)
f = urllib2.urlopen(req)
data = f.read()

parsed_data = json.loads(data)

print('# this output is generated by /usr/local/bin/get_services_with_workhours.py, probably by cron\n')

for service in parsed_data['config']['services']:
<% @downtimes.each do |downtimes_key, downtimes_value| -%>
 <% @downtimes_value.each do |downtime_parameter_key, downtime_paramater_value| -%>
  if service['notification_period'] == '<%= downtimes_key -%>':
    print('define downtime {')
    print("        host_name            %s " % (service['host_name']) )
    print("        service_description  %s " % (service['service_description']) )
    print('        author               <%= downtime_parameter_value['author'] -%>')
    print('        comment              <%= downtime_parameter_value['comment'] -%>')
    <% downtime_parameter_value['downtime_period'].each do |dtperiod| -%>
    print('        downtime_period      <%= dtperiod -%>')
    <% end -%>
    print('        propagate            1')
    print('        register             1')
    print('}\n')
 <% end -%>
<% end -%>
