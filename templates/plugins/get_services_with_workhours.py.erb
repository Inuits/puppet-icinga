#!/usr/bin/python

import urllib2
import json

url = '<%= @icinga_url %>'
username = '<%= @icinga_user %>'
password = '<%= @icinga_pass %>'

passman = urllib2.HTTPPasswordMgrWithDefaultRealm()
passman.add_password(None, url, username, password)
urllib2.install_opener(urllib2.build_opener(urllib2.HTTPBasicAuthHandler(passman)))

req = urllib2.Request(url)
f = urllib2.urlopen(req)
data = f.read()

parsed_data = json.loads(data)

print('# this output is generated by /usr/local/bin/get_services_with_workhours.py, probably by cron\n')

for service in parsed_data['config']['services']:
  if service['notification_period'] == 'workhours':
    print('define downtime {')
    print("        host_name            %s " % (service['host_name']) )
    print("        service_description  %s " % (service['service_description']) )
    print('        author               monitor')
    print('        comment              Schedule downtime for services with workhours notifications')
    print('        downtime_period      monday 00:00-09:00,18:00-24:00')
    print('        downtime_period      tuesday 00:00-09:00,18:00-24:00')
    print('        downtime_period      wednesday 00:00-09:00,18:00-24:00')
    print('        downtime_period      thursday 00:00-09:00,18:00-24:00')
    print('        downtime_period      friday 00:00-09:00,18:00-24:00')
    print('        downtime_period      saturday 00:00-24:00')
    print('        downtime_period      sunday 00:00-24:00')
    print('        propagate            1')
    print('        register             1')
    print('}\n')
  if service['notification_period'] == 'sportoaseOpeningHours':
    print('define downtime {')
    print("        host_name            %s " % (service['host_name']) )
    print("        service_description  %s " % (service['service_description']) )
    print('        author               monitor')
    print('        comment              Schedule downtime for services with workhours notifications')
    print('        downtime_period      monday 00:00-08:00,22:00-24:00')
    print('        downtime_period      tuesday 00:00-08:00,22:00-24:00')
    print('        downtime_period      wednesday 00:00-08:00,22:00-24:00')
    print('        downtime_period      thursday 00:00-08:00,22:00-24:00')
    print('        downtime_period      friday 00:00-08:00,22:00-24:00')
    print('        downtime_period      saturday 00:00-08:00,18:00-24:00')
    print('        downtime_period      sunday 00:00-08:00,18:00-24:00')
    print('        propagate            1')
    print('        register             1')
    print('}\n')

